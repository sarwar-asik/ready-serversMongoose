name: Ready the code and deploy

on: [push, workflow_dispatch]

jobs:
  test-server:
    runs-on: ubuntu-latest
    steps:
      - name: Check directory on Linux
        run: |
          echo "Running on ===>"
          node -v
          git -v
          echo "Server details ===>"
          whoami
          pwd
          ls -a
          echo $GITHUB_WORKSPACE

  build:
    runs-on: ubuntu-latest
    needs: [test-server]
    steps:
      - name: Copying the code
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cd app
          cp .env.example .env

      - name: Create Docker network
        run: docker network create ready-servers-network || true

      - name: Build and test with Docker Compose
        run: |
          cd docker
          docker compose up --build -d
          sleep 60
          docker ps -a
      - name: Run tests
        run: |
          cd app
          rm -rf node_modules package-lock.json
          mkdir -p node_modules
          chmod -R 777 node_modules
          npm install
          npm run test

      - name: Cleanup
        if: always()
        run: |
          cd docker
          docker compose down -v

  deploy-server:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Copying the code
        uses: actions/checkout@v4

      - name: Deploy ready
        run: echo "Deployment ready after successful Docker build"
